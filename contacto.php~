<?php

function comprobar_formulario($matriz_formulario){
	
    $error = false;
    extract($matriz_formulario);

    foreach ($matriz_formulario as $k => $v)
    {
        $correcto[$k] = true;
    }
    

	if(!preg_match("/^[a-zA-Z0-9_-]+[a-zA-Z0-9_.-]*@[a-zA-Z0-9_-]+[a-zA-Z0-9_.-]*\.[a-zA-Z]{2,5}$/",$mail)){
		$correcto['email']=false;	
	}
	
	if(!$empresa) {
		$correcto['empresa']=false;
	}
	
	if(!$mensaje) {
		$correcto['mensaje']=false;
	}
	
	foreach ($correcto as $k => $v)
    {
        if ($v == false)
        {
            echo '<p class="aviso_contacto">Rellene correctamente el campo '. $k.'</p>';
            $error = true;
        }
    }//fin for
    return $error;
}//fin validar

function formulario_mail($datos) 
{
	echo '			
			<form method="post" enctype="multipart/form-data" action="'.$_SERVER['REQUEST_URI'].'">
				<table>
					<tr><th class="contacto" colspan="2">Formulario de contacto</th></tr>
					<tr>
						<td>Empresa*:</td>
						<td><input class="contacto" type="text" name="empresa" value="'.$datos['empresa'].'" /></td>
					</tr>
					<tr>
						<td>Contacto:</td>
						<td><input class="contacto" type="text" name="contacto" value="'.$datos['contacto'].'" /></td>
					</tr>
					<tr>
						<td>E-mail*:</td>
						<td><input class="contacto" type="text" name="mail" size="30" maxlength="40" value="'.$datos['mail'].'" /></td>
					</tr>
					<tr>
						<td>Teléfono:</td>
						<td><input class="contacto" type="text" name="telefono" size="10" maxlength="9" value="'.$datos['telefono'].'" /></td>
					</tr>
					<tr>
						<td colspan="2">Mensaje*</td>
					</tr>
					<tr>
						<td colspan="2"><textarea name="mensaje" rows="10" cols="20">'.$datos['mensaje'].'</textarea></td>	
					</tr>
					<tr>
						<td colspan="2"><button class="contacto" type="submit" name="accion" value="enviar">Enviar</button></td>
					</tr>
				</table>	
			</form>

	';
}
?>

<div id="contenedor">

	<h2>Contacto</h2>
	
	<div id="google_map">
		<iframe width="425" height="350" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="http://maps.google.es/maps?hl=es&amp;georestrict=input_srcid:e59c995b8b05a5a8&amp;ie=UTF8&amp;view=map&amp;cid=10278059054704427216&amp;q=Transmisiones+JPA+S.L.&amp;hq=Transmisiones+JPA+S.L.&amp;hnear=&amp;ll=40.515218,-3.408959&amp;spn=0.005709,0.00912&amp;z=16&amp;iwloc=A&amp;output=embed"></iframe>
	</div>
	<div id="contacto">
	<br />

<?php

if($_POST['accion']=='enviar') 
{
	if(comprobar_formulario($_POST)===false)
	{
		//mandar_email y poner la comprobacion

		 $message = '<table align="center" border="0" bgcolor="#eeeeee" width="600"><tr><td colspan="2" align="center"><b>E-MAIL DESDE SU PÁGINA WEB</b></td></tr>';
	    $message .= '<tr><td width="150"><b>Empresa</b></td><td>'; 
	    $message .= $_POST["empresa"];
	    $message .= '</td></tr>';
	    $message .= '<tr><td><b>Nombre del contacto</b></td><td>';
	    $message .= $_POST["contacto"];
	    $message .= '</td></tr>';
	    $message .= '<tr><td><b>Teléfono</b></td><td>';
	    $message .= $_POST["telefono"];
	    $message .= '</td></tr>';
	    $message .= '<tr><td><b>E-mail</b></td><td>';
	    $message .= $_POST["mail"];
	    $message .= '</td></tr>';
	    $message .= '<tr><td colspan="2"><b>Mensaje</b></td></tr>';
	    $message .= '<tr><td colspan="2">';
	    $message .= $_POST["mensaje"];
	    $message .= '</td></tr>';
	    $message .= '</table>';
	
		//include "includes/class.phpmailer.php";
	
		$mail = new phpmailer();
		$mail->PluginDir = "includes/";
		$mail->Mailer = "smtp";
		$mail->Host = "mail.transmisionesjpa.com";
		$mail->SMTPAuth = true;
		$mail->Username = "jpa@transmisionesjpa.com"; 
		$mail->Password = "Jpa2010";
	 	$mail->From = $_POST['mail'];
		$mail->FromName = $_POST["contacto"];
		$mail->Subject = "E-mail enviado desde la página web";
		//$mail->Body = "<p><b>body</b></p>";
		$mail->Body = "$message";
	    //$message;//envio de datos recogidos
		$mail->AltBody = "Mensaje en formato solo texto";//Aunque vaya en formato html, es necesario esta línea para el envio
		$mail->Timeout=30;
		//$mail->AddAddress("software@nortemadrid.com");//correo de quien lo va a recibir
	
		$mail->AddAddress("jpa@transmisionesjpa.com");//correo de quien lo va a recibir
		
	    $exito = $mail->Send();
	
	    $intentos=1; 
	    while ((!$exito) && ($intentos < 5)) 
	    {
	    	sleep(5);
	        $exito = $mail->Send();
	        $intentos=$intentos+1;
	    }
	    if(!$exito)
	    {
	        	echo '<p class="aviso_contacto">Problemas enviando correo electrónico.';
	    		echo "<br />".$mail->ErrorInfo."</p>";	
	    }
	    else
	    {
	        echo '<p class="aviso_contacto">Correo electrónico enviado correctamente.</p>';
				unset($_POST);
	    }		
		
		
	}
	
}

formulario_mail($_POST);

?>

	</div>

</div>
